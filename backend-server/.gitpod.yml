additionalRepositories:
  - url: https://github.com/vikadata/db-manage
    checkoutLocation: db-manage
  - url: https://github.com/vikadata/vikadata-websocket
    checkoutLocation: vikadata-websocket

image:
  file: .gitpod.Dockerfile


tasks:
  - name: java-server
    # 提前预先编译
    init: |
      source scripts/install-utils.sh
      bash ./devtools.sh setup-redis
      bash ./devtools.sh setup-mysql
      bash ./devtools.sh setup-rabbitmq
      ./gradlew build -x test
    # 启动程序运行命令, redis容易走丢，重新运行一次
    command: |
      bash ./devtools.sh setup-redis
      bash ./devtools.sh launch-service-api
    openMode: tab-before
  # 8081启动后创建测试账号
  - name: init-users & open browser
    command: |
      gp await-port 8081
      bash ./devtools.sh init-users
      gp preview $(gp url 8081)/api/v1/doc.html
  - name: websocket-server
    before: |
      cd ../vikadata-websocket
    init: |
      yarn
    command: |
      yarn run start:dev
    openMode: tab-after
  # 一个独立的命令行窗口用于自由编辑
  - name: command line for free
    command: echo "Hi, Vikaer"
    openMode: tab-after
              
ports:
  # Java Server (/api/v1/doc.html)
  - port: 8081
    onOpen: ignore
  # Adminer
  - port: 8088
    onOpen: open-preview
