<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.vikadata.api.modular.automation.mapper.AutomationTriggerMapper">

    <resultMap id="triggerDto" type="com.vikadata.api.modular.automation.model.AutomationTriggerDto">
        <result column="robot_id" property="robotId" javaType="String"/>
        <result column="trigger_id" property="triggerId" javaType="String"/>
        <result column="trigger_type_id" property="triggerTypeId" javaType="String"/>
        <result column="input" property="input"
                typeHandler="com.vikadata.api.handler.mybatis.JsonHandler"/>
    </resultMap>

    <select id="getTriggersByResourceId" resultMap="triggerDto">
        SELECT trg.robot_id as robot_id,
               trg.trigger_id,
               trg.trigger_type_id,
               trg.input
        FROM vika_automation_trigger trg
                 JOIN vika_automation_robot rbt
            ON rbt.resource_id = #{resourceId} and rbt.robot_id = trg.robot_id and rbt.is_active = 1
        WHERE trg.is_deleted = 0
    </select>

    <select id="getTriggersBySeqId" resultMap="triggerDto">
        SELECT trg.robot_id as robot_id,
               trg.trigger_id,
               trg.trigger_type_id,
               trg.input
        FROM vika_automation_trigger trg
                 JOIN vika_automation_robot rbt
                      ON rbt.seq_id = #{seqId} and rbt.resource_id = #{resourceId} and rbt.robot_id = trg.robot_id and rbt.is_active = 1
        WHERE trg.is_deleted = 0;
    </select>

    <update id="deleteTriggerById">
        UPDATE vika_automation_trigger
        SET is_deleted = 1
        WHERE trigger_id = #{triggerId}
    </update>

    <update id="deleteTriggerByRobotId">
        UPDATE vika_automation_trigger
        SET is_deleted = 1
        WHERE robot_id = #{robotId}
    </update>

    <update id="updateInput">
        UPDATE vika_automation_trigger
        SET input = #{input},
            trigger_type_id = #{triggerTypeId}
        WHERE trigger_id = #{triggerId}
          AND is_deleted = 0
    </update>

</mapper>
