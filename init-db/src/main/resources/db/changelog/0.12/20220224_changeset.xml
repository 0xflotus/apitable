<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
	  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
    <changeSet id="V0.12-20220224-001" author="Zoe" labels="order">
        <comment>经济系统-订单表-新增订单渠道字段</comment>
        <sql>
            ALTER TABLE `${table.prefix}economic_order` ADD `order_channel` varchar(20) CHARACTER SET utf8mb4 COLLATE
                    utf8mb4_unicode_ci DEFAULT 'vika' COMMENT '订单渠道(vika,lark,dingtalk,wecom)' AFTER `order_no`;
        </sql>
    </changeSet>
    <changeSet id="V0.12-20220224-002" author="Zoe" labels="order">
        <comment>经济系统-订单表-新增渠道订单号字段</comment>
        <sql>
            ALTER TABLE `${table.prefix}economic_order` ADD `channel_order_id` varchar(100) CHARACTER SET utf8mb4 COLLATE
                utf8mb4_unicode_ci DEFAULT NULL COMMENT '其他渠道订单号' AFTER `order_channel`;
        </sql>
    </changeSet>
    <changeSet id="V0.12-20220224-003" author="Zoe" labels="order">
        <comment>经济系统-订单表-新增订单阶段字段</comment>
        <sql>
            ALTER TABLE `${table.prefix}economic_order` ADD `order_phase` varchar(20) CHARACTER SET utf8mb4 COLLATE
                utf8mb4_unicode_ci DEFAULT 'fixedterm' COMMENT '订单阶段(trial:试用,fixedterm:固定期限)' AFTER `expire_time`;
        </sql>
    </changeSet>
    <changeSet id="V0.12-20220224-004" author="Zoe" labels="order">
        <comment>经济系统-订单表-修改订单类型字段</comment>
        <sql>
            ALTER TABLE `${table.prefix}economic_order` MODIFY COLUMN `type` tinyint unsigned NOT NULL DEFAULT '0' COMMENT
                '订单类型(0: 新购, 1: 升级, 2: 续订)';
        </sql>
    </changeSet>
    <changeSet id="V0.12-20220224-005" author="Zoe" labels="order">
        <comment>计费系统-增加订单自定义键值对参数表</comment>
        <sql>
            CREATE TABLE `${table.prefix}economic_order_metadata`
            (
                `id`            bigint(20) unsigned NOT NULL COMMENT '主键',
                `order_no`      varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT '订单号',
                `order_channel` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT 'vika' COMMENT '订单渠道(vika,lark,dingtalk,wecom)',
                `metadata`      json                                                         DEFAULT NULL COMMENT '元数据',
                `is_deleted`    tinyint unsigned NOT NULL DEFAULT '0' COMMENT '删除标记(0:否,1:是)',
                `created_at`    timestamp NOT NULL                                           DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
                `updated_at`    timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
                PRIMARY KEY (`id`) USING BTREE,
                UNIQUE KEY `uk_order_no` (`order_no`) USING BTREE COMMENT '订单号唯一'
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='经济模块-订单自定义键值对参数表';
        </sql>
    </changeSet>
    <changeSet id="V0.12-20220224-006" author="Chambers" labels="space">
        <comment>空间申请表增加空间ID索引</comment>
        <sql>
            ALTER TABLE `${table.prefix}space_apply`
                ADD INDEX `idx_space_id`(`space_id`) USING BTREE;
        </sql>
    </changeSet>
    <changeSet id="V0.12-20220224-007" author="Chambers" labels="space">
        <comment>空间邀请链接表增加空间ID索引</comment>
        <sql>
            ALTER TABLE `${table.prefix}space_invite_link`
                ADD INDEX `idx_space_id`(`space_id`) USING BTREE;
        </sql>
    </changeSet>
    <changeSet id="V0.12-20220224-008" author="Chambers" labels="space">
        <comment>空间邀请链接表增加创建者成员ID索引</comment>
        <sql>
            ALTER TABLE `${table.prefix}space_invite_link`
                ADD INDEX `idx_creator`(`creator`) USING BTREE;
        </sql>
    </changeSet>
    <changeSet id="V0.12-20220224-009" author="Chambers" labels="template">
        <comment>模板表增加类型标识ID索引</comment>
        <sql>
            ALTER TABLE `${table.prefix}template`
                ADD INDEX `idx_type_id`(`type_id`) USING BTREE;
        </sql>
    </changeSet>
    <changeSet id="V0.12-20220224-010" author="Chambers" labels="vcode">
        <comment>V码使用记录表增加操作者ID索引</comment>
        <sql>
            ALTER TABLE `${table.prefix}code_usage`
                ADD INDEX `idx_operator`(`operator`) USING BTREE;
        </sql>
    </changeSet>
</databaseChangeLog>
